<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        .my-validation-form {display: none;}

        .map_wrap {position:relative;width:100%;height:350px;}
        .title {font-weight:bold;display:block;}
        .hAddr {position:absolute;left:10px;top:10px;border-radius: 2px;background:#fff;background:rgba(255,255,255,0.8);z-index:1;padding:5px;}
        #centerAddr {display:block;margin-top:2px;font-weight: normal;}
        .bAddr {padding:5px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}
    </style>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=94fa44e37edff70a86093f3bcbc462fa&libraries=services"></script>


</head>
<body>
<div class="my-validation-form" >
    <label for="yLatGyeong">LAT:</label>
    <input type="text" id="yLatGyeong" name="yLatGyeong" >
    <label for="xLntWi">LNT:</label>
    <input type="text" id="xLntWi" name="xLntWi" >
</div>


<script>
    var latitude; // 위도를 저장할 전역 변수
    var longitude; // 경도를 저장할 전역 변수
    var map; // 카카오맵 지도를 저장할 전역 변수
    var geocoder; // 주소-좌표 변환 객체를 저장할 전역 변수

    window.onload = function() {
        if (navigator.geolocation) {
            // 위치 정보를 정기적으로 얻기
            var id = navigator.geolocation.watchPosition(
                function(pos) {
                    console.log(pos.coords.latitude);
                    console.log(pos.coords.longitude);

                    latitude = pos.coords.latitude; // 전역 변수에 위도 할당
                    longitude = pos.coords.longitude; // 전역 변수에 경도 할당

                    $('input[name=xLntWi]').attr('value', pos.coords.latitude);
                    $('input[name=yLatGyeong]').attr('value', pos.coords.longitude);

                    // 감시를 중지하고 지도 생성
                    navigator.geolocation.clearWatch(id);
                    createMap();
                });

        } else {
            alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.")
        }
    }; // end onload

    function createMap() {
        // 카카오맵 지도생성
        var container = document.getElementById('map');

         // 주소 정보를 저장할 변수 선언
        var myPositionAddress;

        var options = {
            center: new kakao.maps.LatLng(latitude, longitude),
            level: 3
        };
        map = new kakao.maps.Map(container, options);

        // 카카오맵 api 좌표->주소변환
        // 주소-좌표 변환 객체를 생성합니다
        geocoder = new kakao.maps.services.Geocoder();

        var marker = new kakao.maps.Marker(), // 클릭한 위치를 표시할 마커입니다
            infowindow = new kakao.maps.InfoWindow({zindex:1}); // 클릭한 위치에 대한 주소를 표시할 인포윈도우입니다

        // 현재 지도 중심좌표로 주소를 검색해서 지도 좌측 상단에 표시합니다
        searchAddrFromCoords(map.getCenter(), displayCenterInfo);

        // 지도를 클릭했을 때 클릭 위치 좌표에 대한 주소정보를 표시하도록 이벤트를 등록합니다
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var detailAddr = !!result[0].road_address ? '<div>도로명주소 : ' + result[0].road_address.address_name + '</div>' : '';
                    detailAddr += '<div>지번 주소 : ' + result[0].address.address_name + '</div>';

                    var detailAddr2 = !!result[0].road_address ? result[0].road_address.address_name : '';
                    detailAddr2 =  result[0].address.address_name;

                    var content = '<div class="bAddr">' +
                                    '<span class="title">내주소정보</span>' +
                                    detailAddr +
                                '</div>';

                    // 마커를 클릭한 위치에 표시합니다
                    marker.setPosition(mouseEvent.latLng);
                    marker.setMap(map);

                    // 인포윈도우에 클릭한 위치에 대한 법정동 상세 주소정보를 표시합니다
                    infowindow.setContent(content);
                    infowindow.open(map, marker);

                     // input 요소에 주소 정보 할당
                    document.getElementById('mypositionaddr').value = detailAddr2;
                }
            });
        });

        // 중심 좌표나 확대 수준이 변경됐을 때 지도 중심 좌표에 대한 주소 정보를 표시하도록 이벤트를 등록합니다
        kakao.maps.event.addListener(map, 'idle', function() {
            searchAddrFromCoords(map.getCenter(), displayCenterInfo);
        });


    } //end createMap()함수


    function searchAddrFromCoords(coords, callback) {
        // 좌표로 행정동 주소 정보를 요청합니다
        geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);
    }

    function searchDetailAddrFromCoords(coords, callback) {
        // 좌표로 법정동 상세 주소 정보를 요청합니다
        geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

    // 지도 좌측상단에 지도 중심좌표에 대한 주소정보를 표출하는 함수입니다
    function displayCenterInfo(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var infoDiv = document.getElementById('centerAddr');

            for(var i = 0; i < result.length; i++) {
                // 행정동의 region_type 값은 'H' 이므로
                if (result[i].region_type === 'H') {
                    infoDiv.innerHTML = result[i].address_name;
                    break;
                }
            }
        }
    }

</script>

    <h1>내위치정보확인</h1>


<div class="map_wrap">
    <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
    <div class="hAddr">
        <span class="title">지도중심기준 주소정보</span>
        <span id="centerAddr"></span>
    </div>
</div>

<form class="validation-form" novalidate action="shop_mypositioncheckok"
      method="post">
    <label for="mypositionaddr">내위치주소확인:</label>
    <input type="text" id="mypositionaddr" name="mypositionaddr" value=" ">
    <button type="submit">내주변맛집조회</button>
</form>


</body>
</html>